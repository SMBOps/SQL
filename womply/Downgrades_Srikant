select 
	ccpm.processor_merchant_id, 
	ccpm.mid_provider_id, 
	part.name as MID_Provider,
	ml.branding_partner_id,
	bp.name as Brand_Partner_Name,
	ml.claimed_at,
	pa.created_at as Action_Date,
	pa.action_code,
	CASE pa.action_code
		WHEN 0 THEN "INSIGHTS_LITE_ACTIVATED_VIA_ADMIN"
  		WHEN 1 THEN "INSIGHTS_LITE_DEACTIVATED_VIA_ADMIN"
  		WHEN 2 THEN "INSIGHTS_ESSENTIALS_ACTIVATED_VIA_ADMIN"
  		WHEN 3 THEN "INSIGHTS_ESSENTIALS_DEACTIVATED_VIA_ADMIN"
  		WHEN 4 THEN "LOYALTY_CLOUD_ACTIVATED_VIA_ADMIN"
  		WHEN 5 THEN "LOYALTY_CLOUD_DEACTIVATED_VIA_ADMIN"
  		WHEN 6 THEN "INSIGHTS_LITE_ACTIVATED_VIA_SIGNUP"
  		WHEN 7 THEN "INSIGHTS_LITE_DEACTIVATED_VIA_SIGNUP"
  		WHEN 8 THEN "INSIGHTS_ESSENTIALS_ACTIVATED_VIA_SIGNUP"
  		WHEN 9 THEN "INSIGHTS_ESSENTIALS_DEACTIVATED_VIA_SIGNUP"
  		WHEN 10 THEN "LOYALTY_CLOUD_ACTIVATED_VIA_SIGNUP"
  		WHEN 11 THEN "LOYALTY_CLOUD_DEACTIVATED_VIA_SIGNUP"
  		WHEN 12 THEN "INSIGHTS_LITE_ACTIVATED_VIA_DASHBOARD"
  		WHEN 13 THEN "INSIGHTS_LITE_DEACTIVATED_VIA_DASHBOARD"
  		WHEN 14 THEN "INSIGHTS_ESSENTIALS_ACTIVATED_VIA_DASHBOARD"
  		WHEN 15 THEN "INSIGHTS_ESSENTIALS_DEACTIVATED_VIA_DASHBOARD"
  		WHEN 16 THEN "LOYALTY_CLOUD_ACTIVATED_VIA_DASHBOARD"
  		WHEN 17 THEN "LOYALTY_CLOUD_DEACTIVATED_VIA_DASHBOARD"
  		WHEN 18 THEN "INSIGHTS_LITE_ACTIVATED_VIA_ADMIN_AUTO_ENROLLMENT"
  		WHEN 19 THEN "INSIGHTS_LITE_DEACTIVATED_VIA_ADMIN_UNENROLLMENT"
  		WHEN 20 THEN "INSIGHTS_ESSENTIALS_ACTIVATED_VIA_ADMIN_AUTO_ENROLLMENT"
 		WHEN 21 THEN "INSIGHTS_ESSENTIALS_DEACTIVATED_VIA_ADMIN_UNENROLLMENT"
  		WHEN 22 THEN "LOYALTY_CLOUD_ACTIVATED_VIA_ADMIN_AUTO_ENROLLMENT"
  		WHEN 23 THEN "LOYALTY_CLOUD_DEACTIVATED_VIA_ADMIN_UNENROLLMENT"
  		WHEN 24 THEN "INSIGHTS_LITE_ACTIVATED_VIA_CONTROL_CENTER"
  		WHEN 25 THEN "INSIGHTS_LITE_DEACTIVATED_VIA_CONTROL_CENTER"
  		WHEN 26 THEN "INSIGHTS_ESSENTIALS_ACTIVATED_VIA_CONTROL_CENTER"
  		WHEN 27 THEN "INSIGHTS_ESSENTIALS_DEACTIVATED_VIA_CONTROL_CENTER"
  		WHEN 28 THEN "LOYALTY_CLOUD_ACTIVATED_VIA_CONTROL_CENTER"
  		WHEN 29 THEN "LOYALTY_CLOUD_DEACTIVATED_VIA_CONTROL_CENTER"
  		WHEN 30 THEN "INSIGHTS_LITE_ACTIVATED_VIA_CCPM_UPLOADER"
  		WHEN 31 THEN "INSIGHTS_LITE_DEACTIVATED_VIA_CCPM_UPLOADER"
  		WHEN 32 THEN "INSIGHTS_ESSENTIALS_ACTIVATED_VIA_CCPM_UPLOADER"
  		WHEN 33 THEN "INSIGHTS_ESSENTIALS_DEACTIVATED_VIA_CCPM_UPLOADER"
	END as Action_Taken,
	pa.merchant_location_id, 
	CASE p.type
		WHEN "InsightsProduct" THEN "Insights Lite"
    	WHEN "InsightsPlusProduct" THEN "Insights Essentials"
    	ELSE "Insights Essentials"
    END as Active_Product, 
	ccpm.bill_for_essentials, 
	ccpm.trial_end_date,
	cd.downgrade_reason,
	cd.notes,
	cd.free_trial_detail
from credit_card_processor_merchants ccpm
inner join merchant_locations ml on ccpm.merchant_location_id = ml.id
inner join partners part on part.id = ccpm.mid_provider_id
inner join partners bp on bp.id = ml.branding_partner_id
left join products p on ml.id = p.merchant_location_id
left join product_activities pa on pa.product_id = p.id
left join ccpm_details cd on cd.credit_card_processor_merchant_id = ccpm.id and p.type = "InsightsProduct";
